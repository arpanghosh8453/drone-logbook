{
  "project": {
    "name": "DJI Logbook",
    "goal": "Local-first DJI logbook with charts, maps, and analytics. Available as a Tauri v2 desktop app or a Docker-deployable web app.",
    "stack": {
      "desktop": "Tauri v2 (feature: tauri-app)",
      "web": "Axum 0.7 + Nginx (feature: web)",
      "frontend": "React 18 + TypeScript + Vite + Tailwind",
      "state": "Zustand",
      "charts": "ECharts (echarts-for-react)",
      "maps": "MapLibre GL (react-map-gl) + deck.gl",
      "database": "DuckDB (duckdb-rs, bundled)",
      "parser": "dji-log-parser v0.5.7"
    },
    "os": "Linux",
    "runtime": {
      "node": "18.x",
      "rust": "stable (1.85+ required by DuckDB)",
      "tauri_cli": "2.x"
    }
  },
  "dependencies": {
    "frontend": {
      "react": "^18.3.1",
      "react_dom": "^18.3.1",
      "vite": "^6.0.0",
      "tailwindcss": "^3.4.14",
      "zustand": "^5.0.0",
      "echarts": "^5.5.0",
      "echarts_for_react": "^3.0.2",
      "react_map_gl": "^7.1.7",
      "maplibre_gl": "^4.7.0",
      "deck_gl": "^9.x",
      "deck_gl_layers": "^9.x",
      "react_dropzone": "^14.3.5",
      "react_day_picker": "^9.13.0"
    },
    "tauri_plugins": [
      "@tauri-apps/api",
      "@tauri-apps/plugin-dialog",
      "@tauri-apps/plugin-fs",
      "@tauri-apps/plugin-log",
      "@tauri-apps/plugin-shell"
    ],
    "backend": {
      "duckdb_rs": "bundled",
      "dji_log_parser": "0.5.7",
      "axum": "0.7 (web feature, with multipart)",
      "tower_http": "0.5 (web feature, with cors + fs)",
      "env_logger": "0.11",
      "flate2": "1 (gzip compression for backup archives)",
      "tar": "0.4 (tar archive for backup/restore)",
      "tempfile": "3 (dev-dependency for tests)"
    }
  },
  "build_modes": {
    "tauri_app": {
      "description": "Desktop app with Tauri v2 IPC (default feature)",
      "cargo_features": "tauri-app (default)",
      "frontend_env": "VITE_BACKEND unset or != 'web'",
      "commands": {
        "dev": "npm run tauri",
        "build": "npm run tauri build"
      }
    },
    "web": {
      "description": "REST API server with Axum for Docker/web deployment",
      "cargo_features": "web (--no-default-features --features web)",
      "frontend_env": "VITE_BACKEND=web",
      "commands": {
        "dev_frontend": "npm run dev:web",
        "dev_backend": "cargo run --features web --no-default-features",
        "build_frontend": "npm run build:web",
        "build_backend": "cargo build --release --features web --no-default-features",
        "docker": "docker compose up --build"
      }
    }
  },
  "scope": {
    "features": [
      "Import and parse DJI flight logs (bulk import with cooldown).",
      "Local DuckDB storage with telemetry schema, WAL recovery, and migration support.",
      "Overview analytics page (totals, averages, max altitude, max distance from home).",
      "Overview activity heatmap (365-day, 7x52 grid).",
      "Overview donut charts for flights by drone model, batteries used, and flight duration (short/mid/long).",
      "Overview top 3 longest and furthest (distance-from-home) flights.",
      "Battery health: per-serial health bars, inline rename (pencil icon, uniqueness-validated, persisted to localStorage), and per-minute usage history plot (scatter + smoothed line) with zoom slider and drag-to-zoom.",
      "Flight list with rename (pencil icon), delete (trash icon), filters (date range, drone, battery), search, and sorting.",
      "Settings: API key, units (metric/imperial), theme (light/dark/system), delete-all logs.",
      "Settings: shows app data + log directory for troubleshooting.",
      "Charts: height/VPS/speed (metric in km/h), battery, attitude, RC signal, GPS satellites.",
      "Charts: RC uplink/downlink, distance-to-home, and velocity XYZ panels.",
      "Charts: synchronized zoom, drag-to-zoom toggle, reset zoom, auto-scaled Y axes, aligned X-axis ticks, custom tooltip header with pills.",
      "Map: 3D terrain view via MapLibre, global theme styling.",
      "Map: satellite style toggle, gradient flight path with start/end markers.",
      "Map: deck.gl 3D path overlay; map toggles persist in session.",
      "Map: Catmull-Rom spline smoothing, color-by modes (progress/height/speed/distance), hover tooltip.",
      "Map: Flight replay with play/pause, seek slider, speed selector (0.5x-16x), and 3D-aware aircraft marker.",
      "Map: Aircraft toggle to show/hide replay controls and marker. Satellite maxzoom 18, terrain DEM maxzoom 12.",
      "Export: CSV/JSON/GPX/KML downloads from flight stats.",
      "Logging: comprehensive debug logging via tauri-plugin-log (desktop) or env_logger (web).",
      "Crash protection: parser uses spawn_blocking + catch_unwind + timeout. Telemetry validated for GPS range, finite values, altitude/speed sanity.",
      "UI polish: theme variables, tag styling for device/serials, modal scrollbar lock.",
      "UI polish: Import progress counter showing current file out of total during batch imports.",
      "UI polish: Sidebar width remembered across sessions via localStorage.",
      "UI polish: Layout clipping fixes for Tauri on Linux (100vh -> 100% for title bar area).",
      "UI polish: Battery serial rename mapping (frontend-only, persisted to localStorage, shown everywhere).",
      "UI polish: App min-width 1600px with horizontal scrollbar when window is narrower.",
      "Backup & Restore: Export full database (flights, telemetry, keychains) to a portable gzip-compressed tar archive of Parquet files. Import restores data with upsert semantics. Works in both Tauri (native save/open dialogs) and web (browser download/upload).",
      "Data safety: DB backup, corruption handling, telemetry rebuild when column order mismatches.",
      "Docker/Web deployment: Axum REST API mirroring all Tauri commands, Nginx reverse proxy, multi-stage Docker build.",
      "Dual-mode frontend: api.ts adapter uses invoke() for Tauri, fetch() for web. All @tauri-apps imports are dynamic."
    ],
    "out_of_scope": [
      "Cloud sync",
      "External analytics pipelines"
    ]
  },
  "structure": {
    "frontend": {
      "root": "src",
      "key_components": [
        "src/components/dashboard/Dashboard.tsx",
        "src/components/dashboard/FlightList.tsx",
        "src/components/dashboard/FlightStats.tsx",
        "src/components/dashboard/FlightImporter.tsx",
        "src/components/dashboard/SettingsModal.tsx",
        "src/components/dashboard/Overview.tsx",
        "src/components/charts/TelemetryCharts.tsx",
        "src/components/map/FlightMap.tsx"
      ],
      "styles": [
        "src/index.css",
        "tailwind.config.js"
      ],
      "state_store": "src/stores/flightStore.ts (includes batteryNameMap persisted to localStorage)",
      "api_adapter": "src/lib/api.ts",
      "types": "src/types/index.ts",
      "env_types": "src/vite-env.d.ts"
    },
    "backend": {
      "root": "src-tauri/src",
      "key_files": [
        "src-tauri/src/main.rs",
        "src-tauri/src/server.rs",
        "src-tauri/src/database.rs",
        "src-tauri/src/parser.rs",
        "src-tauri/src/models.rs",
        "src-tauri/src/api.rs",
        "src-tauri/src/lib.rs"
      ]
    },
    "docker": {
      "dockerfile": "Dockerfile",
      "compose": "docker-compose.yml (pre-built GHCR image)",
      "compose_build": "docker-compose-build.yml (build from source)",
      "nginx_conf": "docker/nginx.conf",
      "entrypoint": "docker/entrypoint.sh"
    },
    "ci": {
      "tauri_build": ".github/workflows/build.yml",
      "docker_build": ".github/workflows/docker.yml"
    },
    "config": {
      "env": ".env (DJI API key via env var)",
      "local_config": "config.json (API key stored locally)",
      "context_file": ".context (machine-readable project context, gitignored)"
    }
  },
  "data_flow": {
    "import_tauri": [
      "User selects file(s) via native dialog",
      "Tauri command parses using dji-log-parser (spawn_blocking + catch_unwind + 40s timeout)",
      "Parser validates telemetry: skips corrupt frames, filters GPS (lat +/-90, lon +/-180), clamps altitude (<10km) and speed (<100 m/s)",
      "Metadata inserted into flights table",
      "Telemetry bulk inserted with DuckDB Appender (column order enforced)",
      "If telemetry insert fails, flight metadata is cleaned up automatically",
      "UI refreshes flight list and telemetry views"
    ],
    "import_web": [
      "User selects file(s) via HTML file input or drag-and-drop",
      "File uploaded via multipart/form-data to POST /api/import",
      "Axum handler writes to temp file, parser processes identically to Tauri mode",
      "Temp file cleaned up after parsing",
      "JSON response returned with ImportResult"
    ],
    "telemetry_query": [
      "UI requests telemetry for flight via selectFlight()",
      "Store checks if same flight already selected (skip if so)",
      "Store checks _flightDataCache Map (LRU, max 10 entries) for instant hit",
      "On cache miss: api.getFlightData() routes to invoke() or fetch() based on mode",
      "Backend uses get_flight_by_id() for O(1) lookup",
      "Telemetry queries skip COUNT(*) when point_count known from flight metadata",
      "DB returns raw data or downsampled to ~5000 points (1s buckets)",
      "Response cached in frontend store for future re-selection",
      "Frontend converts units and renders charts/maps"
    ]
  },
  "recent_changes": {
    "docker_web_mode": {
      "description": "Added Docker/web deployment mode using Cargo feature flags.",
      "server": "src-tauri/src/server.rs - Axum REST API with all 11 endpoints mirroring Tauri commands. DefaultBodyLimit set to 250MB for large flight log uploads.",
      "api_adapter": "src/lib/api.ts - unified interface: invoke() for Tauri, fetch() for web. Lazy-loads @tauri-apps imports.",
      "feature_flags": "Cargo.toml: tauri-app (default) and web features. All Tauri deps are optional.",
      "main_rs": "Feature-gated: mod tauri_app for desktop, run_web() for Axum server.",
      "frontend_components": "FlightImporter, FlightList, FlightStats, SettingsModal updated with isWebMode() guards and dynamic imports.",
      "vite_config": "Web mode: /api proxy, conditional optimizeDeps, es2022 build target.",
      "docker": "Multi-stage Dockerfile (rust:1.85 -> node:20 -> nginx:stable), docker-compose.yml (GHCR image), docker-compose-build.yml (local build), nginx.conf, entrypoint.sh.",
      "npm_scripts": "Added dev:web and build:web scripts with VITE_BACKEND=web."
    },
    "backup_restore": {
      "description": "Full database backup and restore. Export creates a gzip-compressed tar archive containing Parquet files for flights, telemetry, and keychains tables. Import extracts and upserts data using delete-then-insert for flights (dual unique constraints: id + file_hash) and telemetry, INSERT OR REPLACE for keychains.",
      "backend": "database.rs: export_backup() and import_backup() methods. main.rs: export_backup and import_backup Tauri commands. server.rs: GET /api/backup and POST /api/backup/restore endpoints.",
      "frontend": "api.ts: backupDatabase() and restoreDatabase() with dual-mode support. SettingsModal.tsx: Backup/Restore buttons with loading overlay, spinner, and auto-dismiss messages.",
      "dependencies": "Added flate2 (gzip) and tar (archive) crates to Cargo.toml."
    },
    "dead_code_cleanup": {
      "description": "Removed unused DatabaseError variants (AppDataDirNotFound, NotInitialized) and methods (keychains_dir, get_flight_track, store_keychain, get_keychain) to eliminate compiler warnings."
    },
    "v1_4_0_ui_improvements": {
      "description": "Flight replay system, map fixes, layout fixes, chart zoom improvements, import counter, sidebar persistence.",
      "flight_replay": "FlightMap.tsx: play/pause, seek slider, speed selector (0.5x-16x), 3D-aware DeckGL ScatterplotLayer marker with altitude support.",
      "aircraft_toggle": "FlightMap.tsx: Aircraft toggle in map controls to show/hide replay controls and marker.",
      "sky_layer_fix": "FlightMap.tsx: Removed MapLibre-incompatible sky layer (Mapbox-only) from enableTerrain() that was crashing onLoad.",
      "map_zoom_fix": "FlightMap.tsx: Map maxZoom=22, satellite source maxzoom=18, terrain DEM maxzoom=12 (corrected from actual TileJSON).",
      "layout_clipping": "Dashboard.tsx h-screen to h-full, min-h-0 throughout flex chain. App.tsx flex-col overflow-hidden. index.html 100vh to 100%.",
      "import_counter": "FlightImporter.tsx: Shows 'X of Y files' during batch imports.",
      "sidebar_persistence": "Dashboard.tsx: Sidebar width saved to localStorage and restored on load.",
      "replay_slider_styles": "index.css: Custom slider thumb styles for the flight replay seek bar."
    }
  },
  "behavior": {
    "theme": "Global theme (system/light/dark) applied to body, maps, and charts.",
    "units": "Metric/Imperial conversions for speed, height, distance.",
    "x_axis_ticks": "Shared time axis labels aligned across charts; labels rotated and overlap hidden."
  },
  "data_model": {
    "flight": {
      "fields": [
        "id",
        "fileName",
        "displayName",
        "startTime",
        "durationSecs",
        "totalDistance",
        "droneModel",
        "droneSerial",
        "aircraftName",
        "batterySerial"
      ]
    },
    "telemetry": {
      "fields": [
        "time",
        "latitude",
        "longitude",
        "height",
        "vpsHeight",
        "altitude",
        "speed",
        "velocityX",
        "velocityY",
        "velocityZ",
        "battery",
        "batteryVoltage",
        "batteryTemp",
        "pitch",
        "roll",
        "yaw",
        "rcSignal",
        "rcUplink",
        "rcDownlink",
        "satellites",
        "distanceToHome"
      ]
    }
  },
  "database": {
    "path": "~/.local/share/com.dji-logviewer.app/flights.db (desktop) or /data/dji-logviewer/flights.db (Docker)",
    "tables": {
      "flights": [
        "id",
        "file_name",
        "display_name",
        "file_hash",
        "drone_model",
        "drone_serial",
        "aircraft_name",
        "battery_serial",
        "start_time",
        "end_time",
        "duration_secs",
        "total_distance",
        "max_altitude",
        "max_speed",
        "home_lat",
        "home_lon",
        "point_count",
        "imported_at",
        "notes"
      ],
      "telemetry": [
        "flight_id",
        "timestamp_ms",
        "latitude",
        "longitude",
        "altitude",
        "height",
        "vps_height",
        "altitude_abs",
        "speed",
        "velocity_x",
        "velocity_y",
        "velocity_z",
        "pitch",
        "roll",
        "yaw",
        "gimbal_pitch",
        "gimbal_roll",
        "gimbal_yaw",
        "battery_percent",
        "battery_voltage",
        "battery_current",
        "battery_temp",
        "flight_mode",
        "gps_signal",
        "satellites",
        "rc_signal",
        "rc_uplink",
        "rc_downlink"
      ],
      "keychains": [
        "serial_number",
        "encryption_key",
        "fetched_at"
      ]
    },
    "notes": [
      "Telemetry table column order is enforced; if mismatched it rebuilds automatically.",
      "Bulk inserts use DuckDB Appender matching the exact column order above.",
      "Downsampling occurs when telemetry points exceed ~5000 (1s buckets).",
      "Map track altitude uses COALESCE(height, vps_height, altitude) for relative 3D paths.",
      "App data dir structure: flights.db + keychains/.",
      "Failed telemetry inserts trigger automatic flight metadata cleanup."
    ]
  },
  "api_endpoints": {
    "note": "Web mode only (Axum server). All endpoints mirror Tauri commands.",
    "routes": [
      "POST   /api/import            - Upload flight log (multipart)",
      "GET    /api/flights            - List all flights",
      "GET    /api/flight_data        - Get telemetry (query: flight_id, max_points)",
      "GET    /api/overview           - Overview statistics",
      "DELETE /api/flights/delete     - Delete flight (query: flight_id)",
      "DELETE /api/flights/delete_all - Delete all flights",
      "PUT    /api/flights/name       - Rename flight (JSON: flight_id, display_name)",
      "GET    /api/has_api_key        - Check API key configured",
      "POST   /api/set_api_key        - Set API key (JSON: api_key)",
      "GET    /api/app_data_dir       - Data directory path",
      "GET    /api/app_log_dir        - Log directory path",
      "GET    /api/backup             - Download compressed database backup (tar.gz of Parquet files)",
      "POST   /api/backup/restore     - Upload and restore a backup file (multipart)"
    ]
  },
  "parser": {
    "version": "dji-log-parser v0.5.7",
    "inputs": "DJI .dat/.txt logs",
    "outputs": [
      "Flight metadata (aircraft name, drone model/serial, battery serial, start/end, duration)",
      "Telemetry arrays (time, position, orientation, battery, RC, GPS)"
    ],
    "notes": [
      "Height uses OSD height when available; VPS height stored separately.",
      "Altitude fallback uses altitude if height is missing.",
      "Display name defaults to filename; can be edited in UI.",
      "Corrupt frames (non-finite lat/lon/alt/speed) are skipped with logging.",
      "GPS coordinates outside +/-90 lat / +/-180 lon are treated as out-of-range and excluded.",
      "Altitude/height values >10km and speed >100 m/s are clamped to None.",
      "V13+ logs require keychain decryption; API key fetched from config or default.",
      "File deduplication via SHA256 hash prevents re-importing the same log.",
      "Parsing runs in spawn_blocking with catch_unwind and 40s timeout for crash safety."
    ]
  },
  "commands": {
    "frontend": [
      "npm run dev            - Tauri frontend dev server",
      "npm run dev:web        - Web mode dev server (with /api proxy)",
      "npm run build          - Tauri frontend build",
      "npm run build:web      - Web mode frontend build",
      "npm run preview"
    ],
    "tauri": [
      "npm run tauri          - Full Tauri dev mode",
      "npm run tauri:nowatch  - Tauri dev without file watching"
    ],
    "docker": [
      "docker compose up -d                                    - Run with pre-built GHCR image",
      "docker compose -f docker-compose-build.yml up -d          - Build from source and run",
      "docker compose -f docker-compose-build.yml up --build -d  - Force rebuild from source"
    ]
  },
  "ci_cd": {
    "build_yml": {
      "trigger": "on release published",
      "platforms": ["ubuntu-latest", "windows-latest", "macos-latest"],
      "action": "tauri-apps/tauri-action@v0",
      "artifacts": "Desktop binaries uploaded to GitHub Release"
    },
    "docker_yml": {
      "trigger": "on release published + manual dispatch",
      "registry": "ghcr.io",
      "image": "ghcr.io/arpanghosh8453/dji-logbook",
      "tags": "semver (e.g. 1.2.3, 1.2) + latest (auto) on release; custom tag on manual dispatch"
    }
  },
  "ui": {
    "themes": "CSS variables in src/index.css; body classes theme-light/theme-dark. Light mode uses !important overrides.",
    "filters": "Flight list uses date range popover (react-day-picker), drone and battery selects.",
    "flight_list": "Simple compact list with always-visible rename (pencil icon, sky-400) and delete (trash icon, red-400) icons. Subtitle shows date . duration . distance.",
    "charts": "ECharts with synced zoom; global drag-to-zoom toggle + reset zoom buttons; tooltip header uses pill capsules. Theme-aware base config. Hidden per-chart toolbox enables selection highlight for drag-to-zoom.",
    "map": "MapLibre terrain with deck.gl overlay. Spline-smoothed color-by gradient path, shadow layer, start/end/home markers, hover tooltip.",
    "loading": "Spinner uses border-sky-400 for both-mode visibility."
  },
  "known_issues": [
    "If import fails with column order mismatch, telemetry table rebuild should correct it.",
    "Node engine warnings may appear for some transient packages; app still runs.",
    "Older DJI logs (pre-2020) may produce garbage telemetry values; parser validation filters these out.",
    "macOS binaries are unsigned (no Apple Developer account); users need xattr -d com.apple.quarantine workaround."
  ],
  "notes": {
    "api_key": "Stored locally in config.json; never sent except to DJI API.",
    "db_location_desktop": "App data dir under ~/.local/share/com.dji-logviewer.app (flights.db + keychains/)",
    "db_location_docker": "/data/dji-logviewer (persistent volume)",
    "log_location": "Log files under ~/.local/share/com.dji-logviewer.app/logs/ (desktop) or stdout (Docker)",
    "git": {
      "branch": "main"
    }
  }
}
